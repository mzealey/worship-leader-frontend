// abc2svg - ABC to SVG translator
// @source: https://chiselapp.com/user/moinejf/repository/abc2svg
// Copyright (C) 2014-2019 Jean-Francois Moine - LGPL3+
function ToAudio(){var C=abc2svg.C,scale=new Uint8Array([0,2,4,5,7,9,11]),a_e,p_time,abc_time,play_factor;return{clear:function(){var a_pe=a_e;a_e=null;return a_pe},add:function(start,voice_tb){var kmaps=[],cmaps=[],map,temper,i,n,dt,d,v,top_v,rep_st_s,rep_en_s,rep_nx_s,rep_st_transp,rep_st_map,rep_st_fac,transp,instr=[],s=start;function set_voices(){var v,p_v,s,mi;temper=voice_tb[0].temper;transp=new Int8Array(voice_tb.length);for(v=0;v<voice_tb.length;v++){p_v=voice_tb[v];mi=p_v.instr||0;if(p_v.midictl){p_v.midictl.forEach(function(val,i){switch(i){case 0:mi+=val*128*128;break;case 32:mi+=val*128;break;default:a_e.push(new Float32Array([p_v.sym.istart,1,-1,i,val,1,v]))}})}instr[v]=mi;s=p_v.clef;transp[v]=!s.clef_octave||s.clef_oct_transp?0:s.clef_octave;kmaps[v]=new Float32Array(70);cmaps[v]=new Float32Array(70);p_v.key.v=v;key_map(p_v.key)}}function key_map(s){var i,bmap;if(s.k_bagpipe){bmap=new Float32Array([2.37,1.49,1.53,2.35,1.19,1.51,1.55])}else{bmap=new Float32Array(7);switch(s.k_sf){case 7:bmap[6]=1;case 6:bmap[2]=1;case 5:bmap[5]=1;case 4:bmap[1]=1;case 3:bmap[4]=1;case 2:bmap[0]=1;case 1:bmap[3]=1;break;case-7:bmap[3]=-1;case-6:bmap[0]=-1;case-5:bmap[4]=-1;case-4:bmap[1]=-1;case-3:bmap[5]=-1;case-2:bmap[2]=-1;case-1:bmap[6]=-1;break}}for(i=0;i<10;i++)kmaps[s.v].set(bmap,i*7);cmaps[s.v].set(kmaps[s.v])}function pit2mid(s,i){var note=s.notes[i],p=note.pit+19,a=note.acc;if(transp[s.v])p+=transp[s.v];if(a){if(a==3)a=0;else if(note.micro_n)a=(a<0?-note.micro_n:note.micro_n)/note.micro_d*2;map[p]=a}else{a=map[p]}p=(p/7|0)*12+scale[p%7]+a;if(!temper||a|0!=a)return p;return p+temper[p%12]}function do_tie(s,note,d){var n,end_time=s.time+s.dur,pit=note.pit,p=pit+19,a=note.acc;if(transp[s.v])p+=transp[s.v];for(s=s.next;;s=s.next){if(!s)return d;if(s==rep_en_s){var v=s.v;s=rep_nx_s.ts_next;while(s&&s.v!=v)s=s.ts_next;if(!s)return d;end_time=s.time}if(s.time!=end_time)return d;if(s.type==C.NOTE)break}n=s.notes.length;for(i=0;i<n;i++){note=s.notes[i];if(note.pit==pit){d+=s.dur/play_factor;note.ti2=true;return note.ti1?do_tie(s,note,d):d}}return d}function gen_grace(s){var g,i,n,t,d,s2,next=s.next;if(s.sappo){d=C.BLEN/16}else if((!next||next.type!=C.NOTE)&&s.prev&&s.prev.type==C.NOTE){d=s.prev.dur/2}else{next.ts_prev.ts_next=next.ts_next;next.ts_next.ts_prev=next.ts_prev;for(s2=next.ts_next;s2;s2=s2.ts_next){if(s2.time!=next.time){next.ts_next=s2;next.ts_prev=s2.ts_prev;next.ts_prev.ts_next=next;s2.ts_prev=next;break}}d=next.dur/12;if(d&d-1==0)d=next.dur/2;else d=next.dur/3;next.time+=d;next.dur-=d}n=0;for(g=s.extra;g;g=g.next)if(g.type==C.NOTE)n++;d/=n*play_factor;t=p_time;for(g=s.extra;g;g=g.next){if(g.type!=C.NOTE)continue;gen_notes(g,t,d);t+=d}}function gen_notes(s,t,d){for(var i=0;i<=s.nhd;i++){var note=s.notes[i];if(note.ti2)continue;a_e.push(new Float32Array([s.istart,t,instr[s.v],pit2mid(s,i),note.ti1?do_tie(s,note,d):d,1,s.v]))}}set_voices();let rep_st_t;if(!a_e){a_e=[];abc_time=rep_st_t=p_time=0;play_factor=C.BLEN/4*120/60}else if(s.time<abc_time){abc_time=rep_st_t=s.time}while(s){if(s.tempo){d=0;n=s.tempo_notes.length;for(i=0;i<n;i++)d+=s.tempo_notes[i];play_factor=d*s.tempo/60}dt=s.time-abc_time;if(dt>0){p_time+=dt/play_factor;abc_time=s.time}if(s==rep_en_s){s=rep_nx_s;abc_time=s.time}map=cmaps[s.v];switch(s.type){case C.BAR:if(s.v!=top_v)break;if(s.bar_type[0]==":"){s.bar_type="|"+s.bar_type.slice(1);rep_nx_s=s;if(!rep_en_s)rep_en_s=s;if(rep_st_s){s=rep_st_s;for(v=0;v<voice_tb.length;v++){cmaps[v].set(rep_st_map[v]);transp[v]=rep_st_transp[v]}play_factor=rep_st_fac}else{s=start;set_voices()}abc_time=s.time;break}if(!s.invis){for(v=0;v<voice_tb.length;v++)cmaps[v].set(kmaps[v])}if(s.bar_type[s.bar_type.length-1]==":"){rep_st_s=s;rep_en_s=null;for(v=0;v<voice_tb.length;v++){if(!rep_st_map)rep_st_map=[];if(!rep_st_map[v])rep_st_map[v]=new Float32Array(70);rep_st_map[v].set(cmaps[v]);if(!rep_st_transp)rep_st_transp=[];rep_st_transp[v]=transp[v]}rep_st_fac=play_factor;break}else if(s.text&&s.text[0]=="1"){rep_en_s=s}break;case C.CLEF:transp[s.v]=!s.clef_octave||s.clef_oct_transp?0:s.clef_octave;break;case C.GRACE:if(s.time==0&&abc_time==0){dt=0;if(s.sappo)dt=C.BLEN/16;else if(!s.next||s.next.type!=C.NOTE)dt=d/2;abc_time-=dt}gen_grace(s);break;case C.KEY:key_map(s);break;case C.REST:case C.NOTE:d=s.dur;if(s.next&&s.next.type==C.GRACE){dt=0;if(s.next.sappo)dt=C.BLEN/16;else if(!s.next.next||s.next.next.type!=C.NOTE)dt=d/2;s.next.time-=dt;d-=dt}d/=play_factor;if(s.type==C.NOTE)gen_notes(s,p_time,d);else a_e.push(new Float32Array([s.istart,p_time,0,0,d,0,s.v]));break;case C.STAVES:top_v=s.sy.top_voice;break;case C.BLOCK:if(s.subtype!="midictl")break;a_e.push(new Float32Array([s.istart,p_time,-1,s.ctrl,s.val,1,s.v]));break}s=s.ts_next}}}}if(typeof module=="object"&&typeof exports=="object")exports.ToAudio=ToAudio;
